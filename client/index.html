
<!DOCTYPE html>
<html>
	<head>
		<title>Wars of the Ancients</title>
		<style>
			* { margin: 0; padding: 0; box-sizing: border-box; }
			body { font: 13px Helvetica, Arial; }
			form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
			form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
			form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
			#messageList { list-style-type: none; margin: 0; padding: 0; }
			#messageList li { padding: 5px 10px; }
			#messageList li:nth-child(odd) { background: #eee; }
		</style>
	</head>
	<body>
		<!-- Demo code for socket.io chat app -->
		<ul id="messageList"></ul>
		<form id="messageForm" action="">
			<input id="messageInput" autocomplete="off" /><button>Send</button>
		</form>
	</body>
	<script src="/socket.io/socket.io.js"></script>
	<script src="jquery-3.3.1.min.js"></script>
	<script>
		(() => {
			const socket = io();
			
			var senderColors = {};
			
			// Source: https://gist.github.com/mjackson/5311256
			function hslToRgb(h, s, l) {
				var r, g, b;
				
				if (s == 0) {
					r = g = b = l; // achromatic
				} else {
					function hue2rgb(p, q, t) {
						if (t < 0) t += 1;
						if (t > 1) t -= 1;
						if (t < 1/6) return p + (q - p) * 6 * t;
						if (t < 1/2) return q;
						if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
						return p;
					}

					var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
					var p = 2 * l - q;

					r = hue2rgb(p, q, h + 1/3);
					g = hue2rgb(p, q, h);
					b = hue2rgb(p, q, h - 1/3);
				}

				return [ r * 255, g * 255, b * 255 ];
			}
			
			function generateNewSenderColor(sender) {
				var rgb = hslToRgb(Math.random(), 0.3, 0.3)
				return senderColors[sender] = "#" + rgb[0].toString(16) + rgb[1].toString(16) + rgb[2].toString(16);
			};
			
			function postMessage(sender, message) {
				var color;
				if (!senderColors[sender]) {
					color = generateNewSenderColor(sender);
				} else {
					color = senderColors[sender];
				}
				$("#messageList").append(`<li style="color: ${color};">` + message + "</li>");
			};
			window.postMessage = postMessage;
			
			function ready() {
				console.log("Socket ready.");
				socket.on("chat", postMessage);
			};
			
			$("#messageForm").submit(() => {
				var message = $("#messageInput").val();
				
				console.log(`Sending chat message "${message}" to server.`);
				socket.emit("chat", message);
				
				// Post message to local message list
				postMessage(socket.id, message);
				
				// Clear message field
				$("#messageInput").val("");
				
				// Returning false prevents page from reloading on form submission - supposedly?
				return false;
			});
			
			socket.on("userKey", (data) => {
				// debug
				// console.log(`Server sent ${data} in 'userKey' event.`);
				
				if (data == "ok") {
					ready();
				} else if (data == "req") {
					if (localStorage.userKey) {
						socket.emit("userKey", localStorage.userKey);
					} else {
						socket.emit("userKey", "req");
					}
				} else {
					localStorage.userKey = data;
					socket.emit("userKey", data);
				}
			});
			
			function updateConnectionStatus() {
				// use socket.connected boolean to visually notify user that connection is lost/regained
			};
			socket.on("disconnect", updateConnectionStatus);
			socket.on("reconnect", updateConnectionStatus);
			
			window.socket = socket;
		})();
	</script>
</html>
